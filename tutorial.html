<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; yaramail 3.2.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=4f6ddb47"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Collecting email samples" href="collecting_samples.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/yaramail-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#best-practices">Best practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#methodology">Methodology</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deduplication">Deduplication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#anatomy-of-a-yara-rule">Anatomy of a YARA rule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#meta">meta</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#auth-optional">auth_optional</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-optional">authentication_optional</a></li>
<li class="toctree-l4"><a class="reference internal" href="#category">category</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-domain">from_domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-domains">from_domains</a></li>
<li class="toctree-l4"><a class="reference internal" href="#no-attachment">no_attachment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#no-attachments">no_attachments</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#strings">strings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#condition">condition</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#practical-yara-rule-examples">Practical YARA rule examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#checking-if-an-email-is-safe">Checking if an email is safe</a></li>
<li class="toctree-l3"><a class="reference internal" href="#informational-rules">Informational rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#checking-for-impersonation">Checking for impersonation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#checking-attachment-content">Checking attachment content</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#small-iso-files">Small ISO files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#credential-harvesting-pdfs">Credential harvesting PDFs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#real-world-example-workday">Real world example: Workday</a></li>
<li class="toctree-l3"><a class="reference internal" href="#checking-if-an-email-is-junk">Checking if an email is junk</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-cli">Using the CLI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scanning-an-individual-sample">Scanning an individual sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scanning-multiple-samples">Scanning multiple samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-a-collection-of-samples">Testing a collection of samples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#automating-phishing-report-triage">Automating phishing report triage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="collecting_samples.html">Collecting email samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="regex.html">regex quick reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">yaramail</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Link to this heading"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">yaramail</span></code> provides a workflow for automated triage of phishing reports.</p>
<section id="best-practices">
<h2>Best practices<a class="headerlink" href="#best-practices" title="Link to this heading"></a></h2>
<p>it is <strong>strongly recommended</strong> to create a private Git repository as a place
to develop, store, and maintain  YARA rules, trusted domain lists, and sample
emails, for a number of reasons.</p>
<ul class="simple">
<li><p>Version control tracks who made what change when, with easy rollback</p></li>
<li><p>Automation can (and should) pull a fresh copy of the repository
before scanning</p></li>
<li><p>CI/CD workflows can <a class="reference internal" href="#testing-a-collection-of-samples">run tests</a>
against a collection of emails samples before allowing the rules into
production</p></li>
</ul>
<p>When automating phishing inbox triage, it is <strong>vital</strong> to continually <a class="reference internal" href="collecting_samples.html"><span class="doc std std-doc">build
and maintain a collection</span></a> of real-world malicious, safe,
and junk emails that have been sent to the inbox. That way, new samples can be
tested against existing automation processes, and changes in automation can be
checked for regressions with existing samples.</p>
<p>Production material should be kept in the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch. Any development
should be done in a rule developer’s fork of the repository. New samples for
testing must always be added when adjusting for new content. Each commit should
trigger automated testing of the changes. When the rule developer is ready to
submit their changes for review, they create a Pull Request, and a project
maintainer reviews the proposed changes before squashing and merging commits
into the upstream <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p>
<p>It is recommended to use <a class="reference external" href="https://code.visualstudio.com/">Visual Studio Code</a> as a YARA rule
editor, with the following extensions installed:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=leighlondon.eml">Email</a></p></li>
<li><p><a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens">GitLens</a></p></li>
<li><p><a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ms-python.python">Python</a></p></li>
<li><p><a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack">Remote Development</a></p></li>
<li><p><a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=infosec-intern.yara">YARA</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use Visual Studio Code on Windows Subsystem for Linux (WSL) or remote
host, Visual Studio Code Extensions must be installed in Visual Studio Code for
Windows, and installed again in the WSL distribution or remote host once a new
WSL or remote host window is open.</p>
</div>
</section>
<section id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Link to this heading"></a></h2>
<p>Follow the <a class="reference internal" href="installation.html"><span class="doc std std-doc">installation guide</span></a>.</p>
<p>Import <code class="docutils literal notranslate"><span class="pre">MailScanner</span></code> from <code class="docutils literal notranslate"><span class="pre">yaramail</span></code>, and create a new
<a class="reference internal" href="api.html"><span class="doc std std-doc"><code class="docutils literal notranslate"><span class="pre">MailScanner</span></code> object</span></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">yaramail</span> <span class="kn">import</span> <span class="n">MailScanner</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;scanner&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Initialize the scanner</span>
<span class="n">scanner</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Avoid an IDE warning</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">scanner</span> <span class="o">=</span> <span class="n">MailScanner</span><span class="p">(</span>
    <span class="n">header_rules</span><span class="o">=</span><span class="s2">&quot;header.yar&quot;</span><span class="p">,</span>
    <span class="n">body_rules</span><span class="o">=</span><span class="s2">&quot;body.yar&quot;</span><span class="p">,</span>
    <span class="n">header_body_rules</span><span class="o">=</span><span class="s2">&quot;header_body.yar&quot;</span><span class="p">,</span>
    <span class="n">attachment_rules</span><span class="o">=</span><span class="s2">&quot;attachment.yar&quot;</span><span class="p">,</span>
    <span class="n">implicit_safe_domains</span><span class="o">=</span><span class="s2">&quot;implicit_safe_domains.txt&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not initialize the scanner: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>To scan an email, pass email content, a file-like object, or a file path to
<code class="docutils literal notranslate"><span class="pre">MailScanner.scan_email()</span></code>. Take a look at the <a class="reference internal" href="api.html"><span class="doc std std-doc">API documentation</span></a> to
learn about the returned objects.</p>
</section>
<section id="methodology">
<h2>Methodology<a class="headerlink" href="#methodology" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">yaramail</span></code> module contains a <code class="docutils literal notranslate"><span class="pre">MailScanner</span></code> class. When <code class="docutils literal notranslate"><span class="pre">MailScanner</span></code> scans
an email, it attempts to use a combination of email authentication results and
YARA rule matches to categorize an email and reach a <code class="docutils literal notranslate"><span class="pre">verdict</span></code>. To do this, it
does several things.</p>
<p>First, the <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> header of the email is parsed. The
<code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> header is added by the receiving mail server as a way
of logging the results of authentication checks that prove that the domain
in the message <code class="docutils literal notranslate"><span class="pre">From</span></code> header was not spoofed. Most email services — including
Microsoft 365, and Gmail — use a single <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> header
to log the results of all authentication checks. By default,
all <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> headers will be ignored if multiple
<code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> headers are found in an email. This is done to avoid
false positives when an attacker adds their own <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code>
header to an email before it reaches the destination mail server.</p>
<p>Postfix mail servers use a separate <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> header for each
authentication check. If your mail service does this, set the
<code class="docutils literal notranslate"><span class="pre">allow_multiple_authentication_results</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">True</span></code>.
This allows multiple headers, but all <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> headers will
be ignored if multiple DMARC results are found, to avoid spoofed results.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> are not verified by <code class="docutils literal notranslate"><span class="pre">yaramail</span></code>. This is by design.
Most receiving organizations modify the message subject and/or body prior to
delivery to warn users that an email came from an external source. As a
result, DKIM signatures are not valid after delivery to end user mailboxes.
Only use <code class="docutils literal notranslate"><span class="pre">yaramail</span></code> on emails that have been received by trusted mail
servers, and not on emails received by third parties.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Set <code class="docutils literal notranslate"><span class="pre">allow_multiple_authentication_results</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> <strong>if and only if</strong>
the receiving mail service splits the results of each authentication method
in separate <code class="docutils literal notranslate"><span class="pre">Authentication-Results</span></code> headers <strong>and always</strong> includes DMARC
results.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Set <code class="docutils literal notranslate"><span class="pre">use_authentication_results_original</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>
<strong>if and only if</strong> you use an email security gateway that adds an
<code class="docutils literal notranslate"><span class="pre">Authentication-Results-Original</span></code> header, such as Proofpoint or Cisco
IronPort. This <strong>does not</strong> include API-based email security solutions,
such as Abnormal Security.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Read <a class="reference external" href="https://seanthegeek.net/459/demystifying-dmarc/">Demystifying DMARC</a> for more details about SPF, DKIM, and DMARC.</p>
</div>
<p>Then, the message header, body, and attachment content is scanned with
user-provided <a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html">YARA rules</a> that provide a flexible method of
checking content against known malicious and trusted patterns.</p>
<section id="deduplication">
<h3>Deduplication<a class="headerlink" href="#deduplication" title="Link to this heading"></a></h3>
<p>The purpose of <code class="docutils literal notranslate"><span class="pre">yaramail</span></code> is to identify known safe, known malicious, and
likely junk email samples in phishing reporting inboxes. It will not catch
everything. For proper automation, It is important to implement some form of
deduplication for emails for reported emails that have been manually triaged.
Consider using fuzzy matching approaches such as <a class="reference external" href="https://pypi.org/project/ssdeep/">ssdeep</a>, or use
machine learning capabilities included in many Security Orchestration Automation
and Response (SOAR) platforms.</p>
</section>
</section>
<section id="anatomy-of-a-yara-rule">
<h2>Anatomy of a YARA rule<a class="headerlink" href="#anatomy-of-a-yara-rule" title="Link to this heading"></a></h2>
<p>YARA rules consist of three sections: <code class="docutils literal notranslate"><span class="pre">meta</span></code>, <code class="docutils literal notranslate"><span class="pre">strings</span></code>, and <code class="docutils literal notranslate"><span class="pre">condition</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For better organization of rules, use the <a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#including-files">include directive</a> to
include content from other rule files.</p>
</div>
<section id="meta">
<h3>meta<a class="headerlink" href="#meta" title="Link to this heading"></a></h3>
<p>The <a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#metadata">meta section</a> specifies arbitrary metadata key = value
pairs of metadata that can be useful to humans and/or the scanner application.
<code class="docutils literal notranslate"><span class="pre">yaramail</span></code> uses a few specific <code class="docutils literal notranslate"><span class="pre">meta</span></code> keys.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">meta</span></code> section of each matching rule is checked
for an optional <code class="docutils literal notranslate"><span class="pre">category</span></code> key. Each match category is added to a
deduplicated list of <code class="docutils literal notranslate"><span class="pre">categories</span></code>, if the additional criteria specified in
the rule’s <code class="docutils literal notranslate"><span class="pre">meta</span></code> section is met.</p>
<p>If a single category is in the list of <code class="docutils literal notranslate"><span class="pre">categories</span></code>, the <code class="docutils literal notranslate"><span class="pre">verdict</span></code> is set to
that category. If multiple categories are listed, the verdict is set to
<code class="docutils literal notranslate"><span class="pre">ambiguous</span></code>. If no categories are listed, the verdict is set to <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In extremely rare cases, a trusted domain may send a wide variety of automated
emails that do not fit into patterns, making YARA rules impractical.
To account for this, a domain can be added to the <code class="docutils literal notranslate"><span class="pre">implicit_safe_domains</span></code>
list, which will add a <code class="docutils literal notranslate"><span class="pre">category</span></code> of <code class="docutils literal notranslate"><span class="pre">safe</span></code> to every email from that
domain, as long as the domain is authenticated. The emails will still be
scanned by YARA, so any YARA category matches other than <code class="docutils literal notranslate"><span class="pre">safe</span></code> will still
return an <code class="docutils literal notranslate"><span class="pre">ambiguous</span></code> verdict.</p>
<p><strong>Only do this as a last resort</strong>, because implicitly trusting all emails from
a domain would cause a malicious email to be categorized as <code class="docutils literal notranslate"><span class="pre">safe</span></code>.</p>
</div>
<section id="auth-optional">
<h4>auth_optional<a class="headerlink" href="#auth-optional" title="Link to this heading"></a></h4>
<p>Do not require domain authentication for the rule’s category to apply.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This only applies when <code class="docutils literal notranslate"><span class="pre">from_domain</span></code> is set.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Only set the <code class="docutils literal notranslate"><span class="pre">auth_optional</span></code> key to <code class="docutils literal notranslate"><span class="pre">true</span></code> if the sender is known to not
properly DKIM sign their email.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Emails without proper authentication may have a spoofed message <code class="docutils literal notranslate"><span class="pre">From</span></code>
domain, so take extra care to write YARA rules matching known safe content as
detailed and narrow as possible.</p>
</div>
</section>
<section id="authentication-optional">
<h4>authentication_optional<a class="headerlink" href="#authentication-optional" title="Link to this heading"></a></h4>
<p>Alias of <code class="docutils literal notranslate"><span class="pre">auth_optional</span></code>.</p>
</section>
<section id="category">
<h4>category<a class="headerlink" href="#category" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">category</span></code> of the rule. This can be any string, but the value <code class="docutils literal notranslate"><span class="pre">safe</span></code> is
special. Rules without a <code class="docutils literal notranslate"><span class="pre">category</span></code> key are considered informational, and do
not contribute to the <code class="docutils literal notranslate"><span class="pre">verdict</span></code>.</p>
</section>
<section id="from-domain">
<h4>from_domain<a class="headerlink" href="#from-domain" title="Link to this heading"></a></h4>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This key <strong>must</strong> be set for rules with a category of <code class="docutils literal notranslate"><span class="pre">safe</span></code>.</p>
</div>
<p>If this key is set, the rule’s <code class="docutils literal notranslate"><span class="pre">category</span></code> only applies to emails when the
message <code class="docutils literal notranslate"><span class="pre">From</span></code> domain that matches this value exactly. Multiple domains can be
specified in this value by separating them with spaces.</p>
<p>Domain authentication must pass, unless that rule has an <code class="docutils literal notranslate"><span class="pre">auth_optional</span></code> meta
key with the value set to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</section>
<section id="from-domains">
<h4>from_domains<a class="headerlink" href="#from-domains" title="Link to this heading"></a></h4>
<p>Alias of <code class="docutils literal notranslate"><span class="pre">from_domain</span></code>.</p>
</section>
<section id="no-attachment">
<h4>no_attachment<a class="headerlink" href="#no-attachment" title="Link to this heading"></a></h4>
<p>If this key is <code class="docutils literal notranslate"><span class="pre">true</span></code>, the rule’s <code class="docutils literal notranslate"><span class="pre">category</span></code> only applies to emails with no
attachments.</p>
</section>
<section id="no-attachments">
<h4>no_attachments<a class="headerlink" href="#no-attachments" title="Link to this heading"></a></h4>
<p>Alias of <code class="docutils literal notranslate"><span class="pre">no_attachment</span></code>.</p>
</section>
</section>
<section id="strings">
<h3>strings<a class="headerlink" href="#strings" title="Link to this heading"></a></h3>
<p>The <a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#strings">strings section</a> specifies strings to match, assigned to
variable names in the format <code class="docutils literal notranslate"><span class="pre">$variable</span> <span class="pre">=</span> <span class="pre">value</span></code>.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#text-strings">Text strings</a> are surrounded by <code class="docutils literal notranslate"><span class="pre">&quot;</span></code></p></li>
<li><p><a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#hexadecimal-strings">Hexadecimal strings</a> are surrounded by <code class="docutils literal notranslate"><span class="pre">{}</span></code></p></li>
<li><p><a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#regular-expressions">Regular expressions</a> are surrounded by <code class="docutils literal notranslate"><span class="pre">/</span></code></p></li>
</ul>
<p><a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#string-modifier-summary">String modifiers</a> can be added after the string value
to set case sensitivity, full word match only, and more.</p>
</section>
<section id="condition">
<h3>condition<a class="headerlink" href="#condition" title="Link to this heading"></a></h3>
<p>The <a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#conditions">condition section</a> describes when the rule should match.
Condition statements can be combined using <code class="docutils literal notranslate"><span class="pre">and/or</span></code>.</p>
<p>Here are some simple examples.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Example</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">all</span> <span class="pre">of</span> <span class="pre">them</span></code></p></td>
<td><p>All of the strings must exist</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">any</span> <span class="pre">of</span> <span class="pre">them</span></code></p></td>
<td><p>Any of the strings must exist</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">of</span> <span class="pre">them</span></code></p></td>
<td><p>At least four instances of any of the strings must exist</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">$magic</span></code></p></td>
<td><p>The string assigned to the variable <code class="docutils literal notranslate"><span class="pre">$magic</span></code> must exist</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">$magic</span> <span class="pre">at</span> <span class="pre">0</span></code></p></td>
<td><p>The string assigned to the variable <code class="docutils literal notranslate"><span class="pre">$magic</span></code> must exist at offset <code class="docutils literal notranslate"><span class="pre">0</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">of</span> <span class="pre">($foo_*)</span></code></p></td>
<td><p>At least three instances of any string assigned to a variable starting with <code class="docutils literal notranslate"><span class="pre">$foo_</span></code> must exist</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">(#foo_*)</span> <span class="pre">&lt;</span> <span class="pre">4</span></code></p></td>
<td><p>The total number of instances of any string assigned to a variable starting with <code class="docutils literal notranslate"><span class="pre">$foo_</span></code>must be less than four</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">$url</span> <span class="pre">and</span> <span class="pre">#url</span> <span class="pre">==</span> <span class="pre">(#trusted_url_*)</span></code></p></td>
<td><p>At least one URL must exist <strong>and</strong> the number of instances of the string assigned to <code class="docutils literal notranslate"><span class="pre">$url</span></code> must equal the total number of instances of any string assigned to a variable starting with <code class="docutils literal notranslate"><span class="pre">$trusted_url_</span></code></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="practical-yara-rule-examples">
<h2>Practical YARA rule examples<a class="headerlink" href="#practical-yara-rule-examples" title="Link to this heading"></a></h2>
<p>Here are some of the ways YARA can be put to good use.</p>
<section id="checking-if-an-email-is-safe">
<h3>Checking if an email is safe<a class="headerlink" href="#checking-if-an-email-is-safe" title="Link to this heading"></a></h3>
<p>The following YARA body rule could be used to ensure that all URLs
in an email body match the domain of a vendor.</p>
<div class="highlight-yara notranslate"><div class="highlight"><pre><span></span><span class="kd">rule</span><span class="w"> </span><span class="n">all_urls_example_vendor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">urls</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// YARA rules can include C-style comments like this one</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    The &quot; : urls&quot; after the rule name sets an optional namespace</span>
<span class="cm">    that can be useful for organizing rules.</span>
<span class="cm">    The default namespace is &quot;default&quot;.</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="k">meta</span><span class="p">:</span>
<span class="w">        </span><span class="n">author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Sean Whalen&quot;</span>
<span class="w">        </span><span class="n">date</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;2022-07-13&quot;</span>
<span class="w">        </span><span class="n">category</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;safe&quot;</span>
<span class="w">        </span><span class="n">from_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;example.com&quot;</span><span class="w"> </span><span class="c1">// Only applies to emails from example.com</span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;All URLs point to the example.com domain&quot;</span>
<span class="w">    </span><span class="k">strings</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;://&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$example_url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;https://example.com&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">    </span><span class="k">condition</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        Require at least one URL for this rule, otherwise all emails with no</span>
<span class="cm">        URLs would match.</span>

<span class="cm">        The total number of URLs must match the number of example.com URls.</span>
<span class="cm">        */</span>

<span class="w">        </span><span class="nv">$url</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="c1">#url == #example_url</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="informational-rules">
<h3>Informational rules<a class="headerlink" href="#informational-rules" title="Link to this heading"></a></h3>
<p>To add additional context without affecting categorization or verdicts, write
a rule without including a <code class="docutils literal notranslate"><span class="pre">category</span></code> value in the <code class="docutils literal notranslate"><span class="pre">meta</span></code> section. Any matches
will still appear in the returned <code class="docutils literal notranslate"><span class="pre">matches</span></code>.</p>
<div class="highlight-yara notranslate"><div class="highlight"><pre><span></span><span class="kd">rule</span><span class="w"> </span><span class="n">short_url</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">meta</span><span class="p">:</span>
<span class="w">        </span><span class="n">author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Sean Whalen&quot;</span>
<span class="w">        </span><span class="n">date</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;2022-08-04&quot;</span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Contains a short URL&quot;</span>
<span class="w">    </span><span class="k">strings</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sr">/https?:\/</span>\<span class="sr">/[\w.]{3,12}\/</span>\<span class="n">w</span><span class="p">{</span>5<span class="p">,</span>14<span class="p">}[</span>\<span class="n">s</span><span class="p">|</span>&quot;<span class="p">|)|</span><span class="c1">#|&gt;]/ ascii wide nocase</span>
<span class="w">    </span><span class="k">condition</span><span class="p">:</span>
<span class="w">        </span><span class="ow">any</span><span class="w"> </span><span class="nb">of</span><span class="w"> </span><span class="nb">them</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="checking-for-impersonation">
<h3>Checking for impersonation<a class="headerlink" href="#checking-for-impersonation" title="Link to this heading"></a></h3>
<p>Impersonating a top executive is a classic social engineering technique. Even
if a target organization has fully implemented DMARC to prevent domain
spoofing, people can still be impersonated in the display name of the
message <code class="docutils literal notranslate"><span class="pre">From</span></code> header, or in the email body. A YARA rule can check for this.
<a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#regular-expressions">regular expressions</a> (regex) are handy, because one string can
match a wide range of name variations.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Use a local copy of <a class="reference external" href="https://github.com/gchq/CyberChef/releases">CyberChef</a> to quickly and privately test
regular expressions.</p>
</div>
<p>Most organizations add something to the beginning of an email subject or body
to let the user know that the email came from an external, untrusted source.
This can be leveraged in a YARA rule to identify external emails that include
the name of an executive or board member in the email headers or body. You can
also add patterns to make exceptions to the rule. This is useful for dealing
with false positives. An exemption to a malicious rule <strong>does not</strong> mean that
the content is safe — it only means that the rule cannot be used for that
content.</p>
<div class="highlight-yara notranslate"><div class="highlight"><pre><span></span><span class="kd">rule</span><span class="w"> </span><span class="n">planet_express_vip_impersonation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">meta</span><span class="p">:</span>
<span class="w">        </span><span class="n">author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Sean Whalen&quot;</span>
<span class="w">        </span><span class="n">date</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;2022-07-14&quot;</span>
<span class="w">        </span><span class="n">category</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;fraud&quot;</span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Impersonation of key employees of Planet Express&quot;</span>
<span class="w">    </span><span class="k">strings</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        /(Hubert|Hugh|Prof\\.?(essor)?) ((Hubert|Hugh) )?Farnsworth/</span>
<span class="cm">        </span>
<span class="cm">        Hubert Farnsworth</span>
<span class="cm">        Hugh Farnsworth</span>
<span class="cm">        Professor Farnsworth</span>
<span class="cm">        Prof. Farnsworth</span>
<span class="cm">        Prof Farnsworth</span>
<span class="cm">        Professor Hubert Farnsworth</span>
<span class="cm">        Professor Hugh Farnsworth</span>
<span class="cm">        Prof. Hubert Farnsworth</span>
<span class="cm">        Prof Hubert Farnsworth</span>
<span class="cm">        Prof. Hugh Farnsworth</span>
<span class="cm">        Prof Hugh Farnsworth</span>
<span class="cm">        </span>
<span class="cm">        /Phil(ip)? (J\\.? )?Fry/</span>
<span class="cm">        </span>
<span class="cm">        Philip Fry</span>
<span class="cm">        Philip J. Fry</span>
<span class="cm">        Philip J Fry</span>
<span class="cm">        Phil Fry</span>
<span class="cm">        Phil J. Fry</span>
<span class="cm">        Phil J Fry</span>
<span class="cm">        */</span>
<span class="w">        </span><span class="nv">$external</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;[EXT]&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span><span class="w"> </span><span class="c1">// External email warning</span>
<span class="w">        </span><span class="nv">$vip_ceo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sr">/(Hubert|Hugh|Prof\\.?(essor)?) ((Hubert|Hugh) )?Farnsworth/</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$vip_cfo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Hermes Conrad&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$vip_cto</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Turanga Leela&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$vip_admin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Amy Wong&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$vip_cdo</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sr">/Phil(ip)? (J\\.? )?Fry/</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$except_slug</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Brain Slug Fundraiser&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span>
<span class="w">    </span><span class="k">condition</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$external</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="nb">of</span><span class="w"> </span><span class="p">(</span><span class="nv">$vip_</span><span class="p">*)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="nb">of</span><span class="w"> </span><span class="p">(</span><span class="nv">$except_</span><span class="p">*)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Full names (often including middle initials) of executives at
publicly-traded US companies can be found in SEC filings, which are
<a class="reference external" href="https://www.sec.gov/edgar/searchedgar/companysearch.html">publicly searchable</a> on EDGAR.</p>
</div>
<p>Rules in the <code class="docutils literal notranslate"><span class="pre">header_body</span></code> ruleset are checked against combined email header
and email body content. A rule like the one above should be added to the
<code class="docutils literal notranslate"><span class="pre">header_body</span></code> ruleset. That way it can identify impersonation in the <code class="docutils literal notranslate"><span class="pre">From</span></code>
header display name and/or the email body.</p>
<p>This was a very simple, practical example. YARA was developed to identify and
classify malware, so it is capable of much more complex pattern matching.
Take the time to read over YARA’s documentation and other resources.</p>
</section>
<section id="checking-attachment-content">
<h3>Checking attachment content<a class="headerlink" href="#checking-attachment-content" title="Link to this heading"></a></h3>
<p>As demonstrated by the previous examples, YARA rules don’t need
to be complex to be effective. The same is true for file/attachment rules.</p>
<p>File types can be identified by looking for a known sequence of bytes at a
particular location/offset in a file (usually at offset <code class="docutils literal notranslate"><span class="pre">0</span></code>, the very beginning
of a file). These file signatures are often called magic bytes or magic
numbers. YARA rules can use these file signatures to target specific file
types.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A helpful list of <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_file_signatures">file type signatures</a> can be found on
Wikipedia. The <a class="reference external" href="https://www.loc.gov/preservation/digital/formats/fdd/browse_list.shtml">Library of Congress</a> maintains extensive descriptions of
many different file types.</p>
</div>
<section id="small-iso-files">
<h4>Small ISO files<a class="headerlink" href="#small-iso-files" title="Link to this heading"></a></h4>
<p>Sometimes attackers will store malicious files inside ISO files, because the
content of ISO files are often not scanned by email security controls.
Although <code class="docutils literal notranslate"><span class="pre">yaramail</span></code> does not scan the contents of malicious ISO files, it can
be used to identify small ISO files.</p>
<p>Legitimate ISO files are large. They are disk images that are most commonly
used as bootable operating system installers that range from hundreds of
megabytes to several gigabytes in size. Malicious ISO files are much
smaller, because they only contain malware payloads.</p>
<p>ISO files contain the bytes <code class="docutils literal notranslate"><span class="pre">43</span> <span class="pre">44</span> <span class="pre">30</span> <span class="pre">30</span> <span class="pre">31</span></code> (which is <code class="docutils literal notranslate"><span class="pre">CD001</span></code> in ASCII) at
offsets <code class="docutils literal notranslate"><span class="pre">0x8001</span></code>, <code class="docutils literal notranslate"><span class="pre">0x8801</span></code>, or <code class="docutils literal notranslate"><span class="pre">0x9001</span></code>. This information can be combined with
the special YARA variable <a class="reference external" href="https://yara.readthedocs.io/en/stable/writingrules.html#file-size">filesize</a> to look for small ISO files.</p>
<div class="highlight-yara notranslate"><div class="highlight"><pre><span></span><span class="kd">rule</span><span class="w"> </span><span class="n">small_iso</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">meta</span><span class="p">:</span>
<span class="w">        </span><span class="n">author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Sean Whalen&quot;</span>
<span class="w">        </span><span class="n">date</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;2022-07-21&quot;</span>
<span class="w">        </span><span class="n">category</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;malware&quot;</span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;A small ISO file&quot;</span>
<span class="w">    </span><span class="k">strings</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$iso</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>43<span class="w"> </span>44<span class="w"> </span>30<span class="w"> </span>30<span class="w"> </span>31<span class="p">}</span><span class="w"> </span><span class="c1">// CD001</span>
<span class="w">    </span><span class="k">condition</span><span class="p">:</span>
<span class="w">        </span><span class="p">(</span><span class="nv">$iso</span><span class="w"> </span><span class="nb">at</span><span class="w"> </span>8001<span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">$iso</span><span class="w"> </span><span class="nb">at</span><span class="w"> </span>8801<span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">$iso</span><span class="w"> </span><span class="nb">at</span><span class="w"> </span>9001<span class="p">)</span>
<span class="w">        </span><span class="ow">and</span><span class="w"> </span><span class="nb">filesize</span><span class="w"> </span>&lt;<span class="w"> </span>200MB
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>These types of conditions can also help to make YARA more efficient when it is
being used as a filesystem scanner.</p>
</div>
</section>
<section id="credential-harvesting-pdfs">
<h4>Credential harvesting PDFs<a class="headerlink" href="#credential-harvesting-pdfs" title="Link to this heading"></a></h4>
<p>Attackers will sometimes create phishing lures and links inside an attached
PDF file instead of the email body. If attackers are not careful about their
Operational Security (OPSEC) when creating PDFs, file metadata will be
embedded into the document, including an <code class="docutils literal notranslate"><span class="pre">author</span></code> field. Even if this field
value is not a real name, it can still be used as a weak method of attribution
if it is used in multiple PDFs in a campaign.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a class="reference external" href="https://exiftool.org/">exiftool</a> can show metadata for a wide variety of file
types, including PDFs.</p>
</div>
<p>The YARA rule below identifies PDFs created by <code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Robot</span> <span class="pre">Devil</span></code> that contain
at least one clickable link.</p>
<div class="highlight-yara notranslate"><div class="highlight"><pre><span></span><span class="kd">rule</span><span class="w"> </span><span class="n">robot_devil_pdf</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">meta</span><span class="p">:</span>
<span class="w">        </span><span class="n">author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Sean Whalen&quot;</span>
<span class="w">        </span><span class="n">date</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;2022-08-09&quot;</span>
<span class="w">        </span><span class="n">category</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;credential-harvesting&quot;</span>
<span class="w">        </span><span class="n">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Robot Devil credential harvesting PDF&quot;</span>
<span class="w">    </span><span class="k">strings</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$pdf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>25<span class="w"> </span>50<span class="w"> </span>44<span class="w"> </span>46<span class="w"> </span>2D<span class="p">}</span><span class="w"> </span><span class="c1">// %PDF-</span>
<span class="w">        </span><span class="nv">$s_author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Author(The Robot Devil)&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span>
<span class="w">        </span><span class="nv">$s_uri</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sr">/URI\(.+\)/</span>
<span class="w">    </span><span class="k">condition</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$pdf</span><span class="w"> </span><span class="nb">at</span><span class="w"> </span>0<span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="nb">of</span><span class="w"> </span><span class="p">(</span><span class="nv">$s_</span><span class="p">*)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Although <code class="docutils literal notranslate"><span class="pre">/URI(</span></code> as a text string could have been used to check for clickable
links, using a regular expression is better in this situation, because it will
show full URLs in the list of matches.</p>
</div>
</section>
</section>
<section id="real-world-example-workday">
<h3>Real world example: Workday<a class="headerlink" href="#real-world-example-workday" title="Link to this heading"></a></h3>
<p>Workday is a SaaS platform for HR management that is used by many large
enterprises. Emails from Workday are very consistent.</p>
<p>Every Workday notification email</p>
<ul class="simple">
<li><p>Has the message <code class="docutils literal notranslate"><span class="pre">From</span></code> domain <code class="docutils literal notranslate"><span class="pre">myworkday.com</span></code></p></li>
<li><p>Is DKIM signed by a key at the domain <code class="docutils literal notranslate"><span class="pre">myworkday.com</span></code></p></li>
<li><p>The organization’s logo as a remote image</p></li>
<li><p>Contains at least one link, and all link URLs start with
<code class="docutils literal notranslate"><span class="pre">https://www.myworkday.com/</span></code> and the employer’s name</p></li>
<li><p>Contains the string “Powered by Workday: A New Day, A Better Way.”</p></li>
</ul>
<p>Because of that, a <code class="docutils literal notranslate"><span class="pre">body</span></code> YARA rule can be used
to verify that the emails came from the expected domain and contain the expected content, with no unexpected
links or attachments.</p>
<div class="highlight-yara notranslate"><div class="highlight"><pre><span></span><span class="kd">rule</span><span class="w"> </span><span class="n">workday</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">meta</span><span class="p">:</span>
<span class="w">        </span><span class="n">author</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Sean Whalen&quot;</span>
<span class="w">        </span><span class="n">date</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;2022-09-06&quot;</span>
<span class="w">        </span><span class="n">category</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;safe&quot;</span>
<span class="w">        </span><span class="n">from_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;myworkday.com&quot;</span>
<span class="w">        </span><span class="n">no_attachments</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="k">strings</span><span class="p">:</span>
<span class="w">        </span><span class="nv">$footer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Powered by Workday: A New Day, A Better Way.&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span>
<span class="w">        </span><span class="nv">$url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sr">/https?\:\/</span>\<span class="c1">// ascii wide nocase</span>
<span class="w">        </span><span class="nv">$redacted_url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sr">/https?\:\/</span>\<span class="sr">/(www\.)?REDACTED.com\/</span>/<span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">        </span><span class="nv">$workday_url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;https://www.myworkday.com/REDACTED/&quot;</span><span class="w"> </span><span class="nb">ascii</span><span class="w"> </span><span class="nb">wide</span><span class="w"> </span><span class="nb">nocase</span>
<span class="w">    </span><span class="k">condition</span><span class="p">:</span>
<span class="w">        </span><span class="ow">all</span><span class="w"> </span><span class="nb">of</span><span class="w"> </span><span class="nb">them</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="c1">#url == (#redacted_url + #workday_url)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="checking-if-an-email-is-junk">
<h3>Checking if an email is junk<a class="headerlink" href="#checking-if-an-email-is-junk" title="Link to this heading"></a></h3>
<p>Users will often send marketing (i.e., junk) mail to a phishing report inbox,
which can be a significant contributor to alert fatigue for those who are
doing inbox triage. YARA rules can help reduce this noise.</p>
<p>Start by looking through junk emails that have been reported. Make note of
words or phrases that are common across different marketing campaigns,
businesses, and industries. For example:</p>
<ul class="simple">
<li><p>discount</p></li>
<li><p>trial</p></li>
<li><p>coupon</p></li>
<li><p>webinar</p></li>
<li><p>subscribe</p></li>
<li><p>ROI</p></li>
<li><p>development</p></li>
<li><p>offer</p></li>
<li><p>price</p></li>
<li><p>cost</p></li>
</ul>
<p>Also include a list of words and phrases common to junk email campaigns
targeted to your specific industry.</p>
<p>Then, use condition statements and boolean logic similar to the previous
examples to count the total number of marketing terms/buzzwords/phrases, the
number of URLs, and any exception strings. The boolean logic can be as complex
as needed. For example, you could set a threshold of matches that must occur,
and potentially lower that threshold if a count of URLs meets another
threshold — because bulk marketing emails tend to have at least several
links, and maybe even a tracking image.</p>
<p>Finding the right combination of strings and condition logic may take some
time, but the reduction in alert fatigue is well worth the effort.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Use a separate junk/marketing rule for each language spoken by your users.</p>
</div>
</section>
</section>
<section id="using-the-cli">
<h2>Using the CLI<a class="headerlink" href="#using-the-cli" title="Link to this heading"></a></h2>
<script id="asciicast-529801" src="https://asciinema.org/a/529801.js" async></script>
<p>the <a class="reference internal" href="cli.html"><span class="doc std std-doc"><code class="docutils literal notranslate"><span class="pre">yaramail</span></code> CLI</span></a> has built-in support for scanning  individual
samples, or an entire collection of samples.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">--rules</span></code>option to specify a path to a directory where the following
files can be found:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">header.yar</span></code> - Rules that apply to email header content</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">body.yar</span></code> - Rules that apply to email body content</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">header_body.yar</span></code> - Rules that apply to header and/or body content</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">attachment.yar</span></code> - Rules that apply to email attachment content</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">passwords.txt</span></code> - A list of passwords to try on password-protected attachments</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">implicit_safe_domains.txt</span></code> - a list of message From domains that return
a safe verdict if the domain is authenticated and no
YARA categories match other than safe</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The expected names of these files can be changed using command-line arguments.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If any of these files are missing or blank, the CLI will issue a warning, but
the scanner will still run using the data it does have.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Starting in version 1.2.0, the contents of the message body will always be
tried as ZIP passwords, along with <code class="docutils literal notranslate"><span class="pre">infected</span></code> and <code class="docutils literal notranslate"><span class="pre">malware</span></code>.</p>
</div>
<section id="scanning-an-individual-sample">
<h3>Scanning an individual sample<a class="headerlink" href="#scanning-an-individual-sample" title="Link to this heading"></a></h3>
<p>To scan an individual sample, pass a path to the sample to <code class="docutils literal notranslate"><span class="pre">yaramail</span></code>.
The scan results will be printed to the terminal’s standard output.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To scan standard input (stdin) use <code class="docutils literal notranslate"><span class="pre">-</span></code> as the path to scan.</p>
</div>
</section>
<section id="scanning-multiple-samples">
<h3>Scanning multiple samples<a class="headerlink" href="#scanning-multiple-samples" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">yaramail</span> <span class="pre">CLI</span></code> accepts wildcards (i.e., <code class="docutils literal notranslate"><span class="pre">*</span></code>) in the scan path to scan
multiple files at once. This is useful for seeing what samples have in common.</p>
</section>
<section id="testing-a-collection-of-samples">
<h3>Testing a collection of samples<a class="headerlink" href="#testing-a-collection-of-samples" title="Link to this heading"></a></h3>
<p>To test <code class="docutils literal notranslate"><span class="pre">verdict</span></code> values across an entire collection of email samples, use the
<code class="docutils literal notranslate"><span class="pre">-t/--test</span></code> option, and pass in a path to a directory of samples that are
sorted into subdirectories by expected verdict.</p>
<p><code class="docutils literal notranslate"><span class="pre">yaramail</span></code> will output the test results as JSON, and use the number of test
failures as the return code. This is designed for developer use, and for CI/CD
testing pipelines.</p>
<p>To see more details about the emails that failed, including headers, body
content, URLs, and attachment names, add the <code class="docutils literal notranslate"><span class="pre">-v/--verbose</span></code> option.</p>
</section>
</section>
<section id="automating-phishing-report-triage">
<h2>Automating phishing report triage<a class="headerlink" href="#automating-phishing-report-triage" title="Link to this heading"></a></h2>
<p>Here’s a complete example of triage code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">mailsuite.utils</span> <span class="kn">import</span> <span class="n">parse_email</span>
<span class="kn">from</span> <span class="nn">yaramail</span> <span class="kn">import</span> <span class="n">MailScanner</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;scanner&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">escalate_to_incident_response</span><span class="p">(</span><span class="n">_report_email</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                                  <span class="n">priority</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span><span class="p">):</span>
  <span class="n">m</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Escalating </span><span class="si">{</span><span class="n">priority</span><span class="si">}</span><span class="s2"> priority email&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
  <span class="c1"># TODO: Do something!</span>


<span class="n">malicious_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;credential-harvesting&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;malware&quot;</span><span class="p">]</span>
<span class="n">malicious_categories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">malicious_categories</span><span class="p">)</span>

<span class="c1"># Initialize the scanner</span>
<span class="n">scanner</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Avoid an IDE warning</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">scanner</span> <span class="o">=</span> <span class="n">MailScanner</span><span class="p">(</span>
    <span class="n">header_rules</span><span class="o">=</span><span class="s2">&quot;header.yar&quot;</span><span class="p">,</span>
    <span class="n">body_rules</span><span class="o">=</span><span class="s2">&quot;body.yar&quot;</span><span class="p">,</span>
    <span class="n">header_body_rules</span><span class="o">=</span><span class="s2">&quot;header_body.yar&quot;</span><span class="p">,</span>
    <span class="n">attachment_rules</span><span class="o">=</span><span class="s2">&quot;attachment.yar&quot;</span><span class="p">,</span>
    <span class="n">implicit_safe_domains</span><span class="o">=</span><span class="s2">&quot;implicit_safe_domains.txt&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not initialize the scanner: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scan_email</span><span class="p">(</span><span class="n">email_sample</span><span class="p">):</span>
  <span class="n">email_sample</span><span class="p">[</span><span class="s2">&quot;yaramail&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">scan_email</span><span class="p">(</span><span class="n">email_sample</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">email_sample</span>


<span class="c1"># TODO: Do something to fetch emails</span>
<span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">emails</span><span class="p">:</span>
  <span class="n">attached_email</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">report_email</span> <span class="o">=</span> <span class="n">parse_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
  <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;valid_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="k">if</span> <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;automatic_reply&quot;</span><span class="p">]:</span>
    <span class="c1"># TODO: Move automatic replies to the trash</span>
    <span class="k">continue</span>
  <span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;attachments&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">attachment</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.eml&quot;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">attached_email</span><span class="p">:</span>
        <span class="c1"># TODO: Tell the user to only send one attached email</span>
        <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;valid_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">escalate_to_incident_response</span><span class="p">(</span><span class="n">report_email</span><span class="p">)</span>
        <span class="c1"># TODO: Move report email to the invalid folder or trash</span>
        <span class="n">attachment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">break</span>
      <span class="n">attached_email</span> <span class="o">=</span> <span class="n">attachment</span>
  <span class="k">if</span> <span class="n">attached_email</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;valid_report&quot;</span><span class="p">]:</span>
    <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;valid_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># TODO: Tell use user how to properly send a sample as an attachment</span>
    <span class="n">escalate_to_incident_response</span><span class="p">(</span><span class="n">report_email</span><span class="p">)</span>
    <span class="c1"># TODO: Move report email to the invalid folder or trash</span>
    <span class="k">continue</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">scan_email</span><span class="p">(</span><span class="n">attached_email</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">])</span>
    <span class="c1">#TODO: Do something to deduplicate manually triaged emails</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email sample: </span><span class="si">{</span><span class="n">_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;valid_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">escalate_to_incident_response</span><span class="p">(</span><span class="n">report_email</span><span class="p">)</span>
    <span class="c1"># TODO: Move report email to the invalid folder or trash</span>
    <span class="k">continue</span>

  <span class="n">report_email</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span>

  <span class="n">is_malicious</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
    <span class="n">malicious_categories</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;yaramail&quot;</span><span class="p">][</span><span class="s2">&quot;categories&quot;</span><span class="p">]))))</span>

  <span class="k">if</span> <span class="n">is_malicious</span><span class="p">:</span>
    <span class="c1"># TODO: Instruct the user to delete the malicious email</span>
    <span class="c1"># TODO: Move report email to the malicious folder or trash</span>
    <span class="c1"># TODO: Maybe do something different for each verdict?</span>
    <span class="n">escalate_to_incident_response</span><span class="p">(</span><span class="n">report_email</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;yaramail&quot;</span><span class="p">][</span><span class="s2">&quot;verdict&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;safe&quot;</span><span class="p">:</span>
    <span class="c1"># TODO: Let the user know the email is safe and close the ticket</span>
    <span class="c1"># TODO: Move the report to the safe folder or trash</span>
    <span class="k">pass</span>
  <span class="k">elif</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;yaramail&quot;</span><span class="p">][</span><span class="s2">&quot;verdict&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;junk&quot;</span><span class="p">:</span>
    <span class="c1"># TODO: Tell the user how to add an address to their spam filter</span>
    <span class="c1"># TODO: Close the ticket and move the report to the junk/trash folder</span>
    <span class="k">pass</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">escalate_to_incident_response</span><span class="p">(</span><span class="n">report_email</span><span class="p">)</span>

</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="collecting_samples.html" class="btn btn-neutral float-right" title="Collecting email samples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Sean Whalen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>